{extend name="/layout" /} 
{block name="main"}
<body class="layui-layout-body">
	<div class="layui-layout layui-layout-admin my-layout-admin">
		{:$html->formBegin()}
			<div class="layui-body" style="top: 0;">
				<div class="layui-tab">
					<ul class="layui-tab-title">
						<li class="layui-this">基本信息</li>
						<li class="">分类信息</li>
						<li class="">图片信息</li>
						<li class="">积分规则</li>
					</ul>
					<div class="layui-tab-content">
						<div class="layui-tab-item layui-show">
							{:$html->input([
								'label'=>'标题',
								'lay-verify'=>'required|title',
								'name'=>'title',
							])}
							{:$html->input([
							'label'=>'关键字',
							'lay-verify'=>'required|entitle',
							'name'=>'entitle',
							])}
							
							{:$html->input([
								'label'=>'价格',
								'lay-verify'=>'required|number',
								'name'=>'price'
							])}
							
							{:$html->input([
								'label'=>'市场价格',
								'lay-verify'=>'required|number',
								'name'=>'saleprice',
							])}
							
							{:$html->input([
								'label'=>'总库存',
								'lay-verify'=>'required|number',
								'name'=>'num',
							])}
							{:$html->input([
							'label'=>'单位名',
							'lay-verify'=>'required|unitname',
							'name'=>'unit_name',
							])}

							{:$html->input([
								'label'=>'预售开始',
								'lay-verify'=>'required',
								'name'=>'salestart',
								'placeholder'=>'请选择预售开始时间'
							])}
							{:$html->input([
							'label'=>'预售结束',
							'lay-verify'=>'required',
							'name'=>'saleend',
							'placeholder'=>'请选择预售结束时间'
							])}

							<div class="layui-form-item">
								<label class="layui-form-label"><span class="tip-red">*</span>配送方式</label>
								<div class="layui-input-block">
									<select name="ptype" required lay-verify="required" lay-filter="pType">
										<option value=""></option>
										<option value="0">配送时间</option>
										<option value="1">配送文本</option>
									</select>
								</div>
							</div>
							{:$html->input([
							'label'=>'配送方式',
							'name'=>'types',
							])}
							{:$html->input([
							'label'=>'配送时间',
							'name'=>'send',
							'placeholder'=>'请选择配送时间',
							'tip'=>'配送时间,配送文本两者选其一填写',
							])}
							{:$html->input([
							'label'=>'配送文本',
							'lay-verify'=>'sendtxt',
							'name'=>'sendtxt',
							'placeholder'=>'请选择配送文本',
							'tip'=>'配送文本最多6个字符',
							])}
							
							{:$html->input([
								'label'=>'佣金比例',
								'lay-verify'=>'required|number',
								'name'=>'scale',
								'tip'=>'团长佣金比例，单位百分比，最多两位小数'
							])}
							{:$html->input([
							'label'=>'赠送积分',
							'lay-verify'=>'required|number',
							'name'=>'gift',
							'tip'=>'若为0，则积分为空',
							'ext'=>'onkeyup="value=zhzs(this.value)"'
							])}
							
							{:$html->input([
								'label'=>'排序',
								'lay-verify'=>'required|number',
								'name'=>'sort',
								'tip'=>'排序号，越大排越前'
							])}
							
							<div class="layui-form-item" pane>
								<label class="layui-form-label">标签</label>
								<div class="layui-input-block">
									{volist name="tags" id="vo"}
										<input type="checkbox" name="tag[{$vo.field}]" title="{$vo.title}" value="1">
									{/volist}
								</div>
							</div>
			            </div>
			            <div class="layui-tab-item">
							<div class="layui-form-item layui-form-text">
			                    <label class="layui-form-label"><span class="tip-red">*</span>商品分类</label>
			                    <div class="layui-input-block muti-select" data-type="1" data-field="category" style="display: flex">
			                        <div class="muti-select-opt">
			                        	{:$html->category($category,false)}
			                        </div>
			                        <div class="muti-select-btn">
			                            <button class="layui-btn layui-btn-sm layui-btn-normal muti-select-all-left"><<全选</button>
			                            <button class="layui-btn layui-btn-sm muti-add-btn">添加>></button>
			                            <button class="layui-btn layui-btn-sm layui-btn-warm muti-remove-btn"><<移除</button>
			                            <button class="layui-btn layui-btn-sm layui-btn-normal muti-select-all-right">全选>></button>
			                        </div>
			                        <div class="muti-select-items">
			                        </div>
			                        <span class="muti-input" style="display: none;"></span>
			                    </div>
			                </div>
						</div>
			            <div class="layui-tab-item">
							{:$html->images([
								'field'=>'single',
								'label'=>'商品主图'
							])}
							{:$html->images([
								'field'=>'atlas',
								'label'=>'商品详情图片'
							])}
						</div>
						<div class="layui-tab-item">
							{:$html->input([
							'label'=>'消耗积分',
							'name'=>'down',
							'tip'=>'若规则启用，消耗积分必须大于0',
							'ext'=>'onkeyup="value=zhzs(this.value)"'
							])}
							{:$html->input([
							'label'=>'优惠现金',
							'name'=>'cash',
							'tip'=>'对该订单满足条件下的优惠金额，不得超出订单总价',
							'ext'=>'onkeyup="value=zhzs(this.value)"'
							])}
							<div class="layui-form-item" pane>
								<label class="layui-form-label">规则状态</label>
								<div class="layui-input-block">

									<input type="checkbox" name="isopen" title="启用" value="1" >

								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		{:$html->formEnd(url($ctrl."/".$action."_add"))}
	</div>
</body>
<script type="text/javascript" src="/plugins/qiniu/jquery-1.12.4.min.js"></script>
<script>

    //转化正整数
    function zhzs(value){

        value = value.replace(/[^\d]/g,'');
        if(''!=value){
            value = parseInt(value);
        }
        return value;

    }

</script>
<script type="text/javascript">	
	window.recall = function(){
        form.verify({
            title: function(value){ //value：表单的值、item：表单的DOM对象
                if(value.length > 40){
                    return '标题不得超40个字符';
                }
            },
            unitname: function(value){ //value：表单的值、item：表单的DOM对象
                if(value.length > 2){
                    return '单位名不得超2个字符';
                }
            },
            entitle: function(value){ //value：表单的值、item：表单的DOM对象
                if(value.length > 18){
                    return '关键字不得超18个字符';
                }
            },
			sendtxt: function(value){ //value：表单的值、item：表单的DOM对象
                if(value.length > 6){
                    return '配送文本不得超6个字符';
                }

            }

        });
        laydate.render({
            elem: '#layinput-send',
            type: 'datetime',
            value: '2018-09-01 00:00:00',
            isInitValue:true //是否允许填充初始值，默认为 true
        });

        laydate.render({
            elem: '#layinput-salestart',
            type: 'datetime'
        });
        laydate.render({
            elem: '#layinput-saleend',
            type: 'datetime'
        });

		$(".upload-img-list").on("click",'#upload-btn-single',function(){
            window.uploadConfig = {
                num : 5,
                container : "#upload-container-single",
                mark : 'single',
                chooseFunc : tools.chooseFile
            }
            tools.adminShow('商品图片,最多5张',"{:url('file/choose')}");
        });
		
		$(".upload-img-list").on("click",'#upload-btn-atlas',function(){
            window.uploadConfig = {
                num : 10,
                container : "#upload-container-atlas",
                mark : 'atlas',
                chooseFunc : tools.chooseFile
            }
            tools.adminShow('商品详情图片,最多10张',"{:url('file/choose')}");
        });
        
        $(".muti-select").on('click',".opt-item", function() {
            if ($(this).hasClass('active')) {
                $(this).removeClass('active');
            }else{
                $(this).addClass('active');
            }
        });

        $("#layinput-send").bind("input propertychange",function(event){
            console.log($("#layinput-send").val())
        });

        $(".muti-select").on('click', '.muti-add-btn', function() {
            var selectHtml = '';
            var parentObj = $(this).parents('.muti-select');
            parentObj.find('.muti-select-opt .active').each(function(index, el) {
                $(this).removeClass('active');
                if (parentObj.data('type') == 1) {
                	selectHtml+=$(this).prop("outerHTML");
                }else{
                	var obj = $($(this).prop("outerHTML"));
	                obj.prepend('<input class="layui-input muti-num-input" name="num[]" lay-verify="required|number|ltZero" placeholder="数量">');
	                selectHtml+=obj.prop("outerHTML");
                }
                $(this).hide();
            });
            parentObj.find(".muti-select-items").append(selectHtml);
            mutiSelect(parentObj);
        });

        $(".muti-select").on('click', '.muti-remove-btn', function() {
        	var parentObj = $(this).parents('.muti-select');
            parentObj.find('.muti-select-items .active').each(function(index, el) {
                var selectId = $(this).data('id');
                parentObj.find('.muti-select-opt div[data-id="'+selectId+'"]').show();
                $(this).remove();
            });
            mutiSelect(parentObj);
        });

        $(".muti-select").on('click', '.muti-select-all-left', function() {
        	var parentObj = $(this).parents('.muti-select');
            parentObj.find('.muti-select-opt .opt-item').each(function(index, el) {
                if ($(this).css('display') != 'none') {
                    $(this).addClass('active');
                }
            });
        });

        $(".muti-select").on('click', '.muti-select-all-right', function() {
        	var parentObj = $(this).parents('.muti-select');
            parentObj.find('.muti-select-items .opt-item').addClass('active');
        });
        var pTxt=$("input[name='send']").val();
        console.log(pTxt);
        $("input[name='send']").parent().parent().hide();
        $("input[name='sendtxt']").parent().parent().hide();
        $("input[name='types']").parent().parent().hide();
        form.render();
        form.on('select(pType)', function(data){
            var ptype=$("select[name='ptype']").find("option:selected").html();
            if(ptype=="配送时间"){
                $("input[name='send']").parent().parent().show();
                $("input[name='sendtxt']").parent().parent().hide();
                $("input[name='types']").val('0');
            }else{
                $("input[name='send']").parent().parent().hide();
                $("input[name='sendtxt']").parent().parent().show();
                $("input[name='types']").val('1');
            }
            form.render();
        });
    }
	function mutiSelect(parentObj){
        var inputStr = '';
        var name = parentObj.data('field');
        parentObj.find('.muti-select-items .opt-item').each(function(index, el) {
            var selectId = $(this).data('id');
            inputStr += '<input type="hidden" name="'+name+'[]" value="'+selectId+'">';
        });
        parentObj.find('.muti-input').html(inputStr);
    }

</script>
{/block}

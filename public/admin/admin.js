var $,element,form,layer,laydate,isExecute=!1,handle,executeTime=0,adminTable,beforeSubForm;layui.use(["form","jquery","layer","laydate","element"],function(){element=layui.element,form=layui.form,$=layui.jquery,layer=layui.layer,laydate=layui.laydate,layer.loading=function(){return layer.load(3)},layer.success=function(e,a){var e=e||"操作成功",a=a||1500;return layer.msg(e,{icon:1,time:a})},layer.error=function(e,a){var e=e||"操作失败",a=a||1500;return layer.msg(e,{icon:2,time:a})},$(".layui-layout-body").on("click",".image-item-del",function(){$(this).parents(".image-item").remove()}),$(".layui-layout-body").on("click",".win-open",function(){var e=$(this).data("url"),a=$(this).data("title")||$.trim($(this).text());tools.adminShow(a,e)}),$("#batch-delete").on("click",function(){var e=$(this).data("url"),a=$(this).data("title");tools.delItem(e,adminTable.getChecked("id"),a)}),$(".batch-deal").on("click",function(){var e=$(this).data("url"),a=$(this).data("title"),t=$(this).data("value"),n=1==t?"确定要启用已选中的"+a:"确定要禁用已选中的"+a;tools.dealItem(e,adminTable.getChecked("id"),t,n)}),$(".m-child-title").on("click",function(){var e=$(this).data("url");$("#main-iframe").attr("src",e),$(".m-child-title").removeClass("active"),$(this).addClass("active"),tools.setCookie("admin-url",e)}),$("#go-main").on("click",function(){var e=$(this).data("url");$("#main-iframe").attr("src",e),$(".m-child-title").removeClass("active"),tools.setCookie("admin-url",e)}),form.on("submit(subform)",function(e){beforeSubForm&&"function"==typeof beforeSubForm&&(e.field=beforeSubForm(e.field)),tools.ajax($(e.elem).data("url"),e.field)});var e=tools.getCookie("admin-url");e&&$(".m-left-menu").find('li[data-url="'+e+'"]').addClass("active"),laydate.render({elem:"#start",type:$("#start").data("type")||"datetime"}),laydate.render({elem:"#end",type:$("#end").data("type")||"datetime"}),$(".batch-deal-btn").on("click",function(){var e=adminTable.getChecked("id"),a=$(this).data("url"),t=$(this).data("msg"),n=$(this).data("val");tools.dealItem(a,e,n,t)}),handle=setInterval(function(){return executeTime>=5e3||isExecute?(clearInterval(handle),!0):(executeTime+=10,void(window.recall&&"function"==typeof window.recall&&(isExecute=!0,window.recall())))},10),adminTable=new Tablejs});var tools={onLoading:!1,delItem:function(e,a,t,n){return t=t||"选项",a&&0!=a.length?void layer.confirm("确定要删除已选中的"+t+"吗？",function(){layer.closeAll(),tools.ajax(e,{dataId:a},function(){"undefined"!=typeof adminTable&&adminTable.render(),"function"==typeof n&&n()})}):(layer.error("请选择要删除的"+t),!1)},dealItem:function(e,a,t,n,i){return a&&0!=a.length?void layer.confirm(n,function(){layer.closeAll(),tools.ajax(e,{dataId:a,value:t},function(){"undefined"!=typeof adminTable&&adminTable.render(),"function"==typeof i&&i()})}):(layer.error("请选择要操作的选项"),!1)},setCookie:function(e,a){var t=30,n=new Date;n.setTime(n.getTime()+24*t*60*60*1e3),document.cookie=e+"="+escape(a)+";expires="+n.toGMTString()},getCookie:function(e){var a,t=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(a=document.cookie.match(t))?unescape(a[2]):null},ajax:function(e,a,t){if(tools.onLoading)return!1;var n=0;$.ajax({url:e,type:"post",dataType:"json",data:a,beforeSend:function(){n=layer.loading(),tools.onLoading=!0}}).done(function(e){if(layer.close(n),1!=e.status){tools.onLoading=!1;var a=e.info||"系统错误";return layer.error(a),!0}return t&&"function"==typeof t?(tools.onLoading=!1,t(e.data),!0):(layer.success("操作成功"),void setTimeout(function(){tools.adminClose(),tools.onLoading=!1,parent.window.adminTable&&parent.window.adminTable.render()},1500))}).fail(function(){layer.close(n),tools.onLoading=!1})},adminClose:function(){var e=parent.layer.getFrameIndex(window.name);parent.layer.close(e)},adminShow:function(e,a,t,n){(null==e||""==e)&&(e=!1),(null==a||""==a)&&(a="404.html"),(null==t||""==t)&&(t=.9*$(window).width()),(null==n||""==n)&&(n=$(window).height()-50),layer.open({type:2,area:[t+"px",n+"px"],fix:!1,maxmin:!0,shadeClose:!1,title:e,content:a})},chooseFile:function(e,a,t,n){var i="",o=0;for(var l in e)v=e[l],i+='<div class="image-item"><i class="fa fa-times image-item-del"></i><img src="'+n+v.key+'" alt=""><input type="hidden" name="'+t+"["+o+'][id]" value="'+v.id+'"><input type="hidden" name="'+t+"["+o+'][key]" value="'+v.key+'"></div>',o+=1;i+='<i class="fa fa-plus upload-plus" id="upload-btn-'+t+'"></i>',$(a).html(i)},table:function(e){var a={jsonUrl:"",node:"#table-box",getWhere:function(){return{}},pagination:{p:1,num:100,total:0,node:"#page-box",limits:[100,200,300,400,500]},beforeSend:function(){layer.loading()},success:function(){layer.closeAll()},error:function(){layer.error("服务器错误，请稍后重试")},dealParam:{},colModel:[]};for(var t in e)a[t]=e[t];adminTable.setConfig(a).render()}};